from __future__ import annotations

from typing import Any, Dict

from core.self_learning_agent import SelfLearningAgent
from tools.web.sqlmap_tool import SqlmapTool


class ExploitAgent(SelfLearningAgent):
    def __init__(self, nim_provider: Any, memory_system: Any):
        super().__init__("ExploitAgentV3", "Controlled exploitation specialist", nim_provider, memory_system)
        self.tool = SqlmapTool()

    async def _reason(self, context: Dict[str, Any]) -> Dict[str, Any]:
        if context.get("scope", {}).get("require_approval", True):
            return {"is_complete": True, "reasoning": "Approval required before exploitation."}
        task = context.get("task", {})
        return {"is_complete": False, "tool": "sqlmap", "params": {"target": task.get("target", "")}}

    async def _act(self, thought: Dict[str, Any]) -> Dict[str, Any]:
        if thought.get("is_complete"):
            return {"success": True, "raw_output": "", "skipped": True}
        out = await self.tool.execute(**thought.get("params", {}))
        return {"success": True, "raw_output": out}

    async def _observe(self, action: Dict[str, Any]) -> Dict[str, Any]:
        if action.get("skipped"):
            return {"success": True, "findings": [], "skipped": True}
        parsed = self.tool.parse(action.get("raw_output", ""))
        return {"success": True, "findings": [parsed], "parsed": parsed}
