import re
from typing import Any, Dict

from tools.base_tool import BaseTool


class MetasploitTool(BaseTool):
    def __init__(self):
        super().__init__("metasploit", "msfconsole", "Metasploit Framework wrapper")

    async def execute(self, resource_script: str, additional_args: str = "") -> str:
        cmd = ["msfconsole", "-q", "-r", resource_script]
        if additional_args:
            cmd += additional_args.split()
        result = await self._run_command(cmd, timeout=1800)
        return result.get("stdout", result.get("error", ""))

    def parse(self, output: str) -> Dict[str, Any]:
        sessions = len(re.findall(r"Meterpreter session \d+ opened", output))
        modules = re.findall(r"Matching Modules\n[-=]+\n(.+?)\n\n", output, re.S)
        return {"sessions_opened": sessions, "module_hits": modules[0].splitlines() if modules else []}
