"""Pentest orchestration routes for the canonical app runtime."""

from __future__ import annotations

import uuid
from typing import Any, Dict, List

from fastapi import APIRouter, BackgroundTasks, HTTPException, Response
from loguru import logger
from pydantic import BaseModel

from agents.orchestrator import PentestOrchestrator

router = APIRouter(prefix="/api/pentest/v3", tags=["pentest-v3"])
compat_router = APIRouter(prefix="/api/v1/pentest", tags=["pentest-v1-compat"])

orchestrator: PentestOrchestrator | None = None


class PentestRequest(BaseModel):
    target: str
    scope: Dict[str, Any]
    scan_types: List[str] = ["recon", "vuln_scan"]
    require_approval: bool = True


class PentestResponse(BaseModel):
    task_id: str
    status: str
    message: str


async def startup_pentest_orchestrator() -> None:
    global orchestrator
    if orchestrator is None:
        try:
            orchestrator = PentestOrchestrator()
            await orchestrator.initialize()
        except Exception as exc:
            orchestrator = None
            logger.warning(f"Pentest orchestrator startup degraded: {exc}")


async def shutdown_pentest_orchestrator() -> None:
    global orchestrator
    if orchestrator is not None:
        await orchestrator.close()
        orchestrator = None


def _get_orchestrator() -> PentestOrchestrator:
    if orchestrator is None:
        raise HTTPException(status_code=503, detail="Pentest orchestrator unavailable")
    return orchestrator


async def _start_pentest(request: PentestRequest, background_tasks: BackgroundTasks) -> PentestResponse:
    active_orchestrator = _get_orchestrator()
    task_id = str(uuid.uuid4())
    background_tasks.add_task(
        active_orchestrator.execute_full_pentest,
        request.target,
        request.scope | {"require_approval": request.require_approval},
        task_id,
    )
    return PentestResponse(task_id=task_id, status="started", message=f"Pentest initiated for {request.target}")


async def _get_status(task_id: str) -> Dict[str, Any]:
    active_orchestrator = _get_orchestrator()
    status = await active_orchestrator.get_task_status(task_id)
    if not status:
        raise HTTPException(status_code=404, detail="Task not found")
    return status


@router.post("/start", response_model=PentestResponse)
async def start_pentest(request: PentestRequest, background_tasks: BackgroundTasks) -> PentestResponse:
    return await _start_pentest(request, background_tasks)


@router.get("/status/{task_id}")
async def get_status(task_id: str) -> Dict[str, Any]:
    return await _get_status(task_id)


@compat_router.post("/start", response_model=PentestResponse, deprecated=True)
async def compatibility_start_pentest(request: PentestRequest, background_tasks: BackgroundTasks, response: Response) -> PentestResponse:
    response.headers["X-API-Deprecated"] = "Use /api/pentest/v3/start"
    return await _start_pentest(request, background_tasks)


@compat_router.get("/status/{task_id}", deprecated=True)
async def compatibility_get_status(task_id: str, response: Response) -> Dict[str, Any]:
    response.headers["X-API-Deprecated"] = "Use /api/pentest/v3/status/{task_id}"
    return await _get_status(task_id)
