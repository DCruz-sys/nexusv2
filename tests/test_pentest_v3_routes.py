from fastapi import FastAPI
from fastapi.testclient import TestClient

from app.routes import pentest_v3


class DummyOrchestrator:
    def __init__(self):
        self.calls = []

    async def execute_full_pentest(self, target, scope, task_id):
        self.calls.append((target, scope, task_id))

    async def get_task_status(self, task_id):
        return {"task_id": task_id, "status": "running"}


def test_compatibility_routes_proxy_to_v3():
    app = FastAPI()
    app.include_router(pentest_v3.router)
    app.include_router(pentest_v3.compat_router)

    pentest_v3.orchestrator = DummyOrchestrator()
    try:
        with TestClient(app) as client:
            resp = client.post(
                "/api/v1/pentest/start",
                json={"target": "example.com", "scope": {"depth": 1}, "require_approval": True},
            )
            assert resp.status_code == 200
            assert resp.headers["x-api-deprecated"] == "Use /api/pentest/v3/start"
            payload = resp.json()
            assert payload["status"] == "started"

            status = client.get(f"/api/v1/pentest/status/{payload['task_id']}")
            assert status.status_code == 200
            assert status.headers["x-api-deprecated"] == "Use /api/pentest/v3/status/{task_id}"
            assert status.json()["task_id"] == payload["task_id"]
    finally:
        pentest_v3.orchestrator = None
