import asyncio

from app.routes import pentest_v3


class BrokenOrchestrator:
    async def initialize(self):
        raise RuntimeError("litellm unavailable")


def test_startup_orchestrator_degrades_when_init_fails(monkeypatch):
    async def _run():
        pentest_v3.orchestrator = None
        monkeypatch.setattr(pentest_v3, "PentestOrchestrator", lambda: BrokenOrchestrator())
        await pentest_v3.startup_pentest_orchestrator()
        assert pentest_v3.orchestrator is None

    asyncio.run(_run())
